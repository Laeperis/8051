# 温湿度/频率监控系统流程图

## 系统总体架构流程图

```mermaid
graph TB
    subgraph "硬件层 (AT89C51)"
        A[系统上电] --> B[硬件初始化]
        B --> C[UART初始化]
        B --> D[LCD1602初始化]
        B --> E[定时器初始化]
        B --> F[外部中断初始化]
        B --> G[I2C/PCF8591初始化]
        
        C --> H[等待上位机命令]
        D --> H
        E --> H
        F --> H
        G --> H
    end
    
    subgraph "上位机层 (PyQt5)"
        I[启动上位机应用] --> J[初始化UI界面]
        J --> K[串口配置]
        K --> L[打开串口连接]
        L --> M[启动串口监听线程]
        M --> N[启动网络发送线程]
    end
    
    subgraph "网络层"
        O[Web服务器] --> P[数据接收API]
        P --> Q[SQLite数据库]
        Q --> R[Web监控界面]
    end
    
    H --> S{接收命令?}
    S -->|是| T[解析命令]
    S -->|否| H
    
    T --> U{命令类型}
    U -->|启动采集S| V[设置采集标志]
    U -->|停止采集E| W[清除采集标志]
    U -->|温湿度通道A| X[切换到DHT11]
    U -->|频率通道B| Y[切换到NE555]
    U -->|报警信号| Z[控制LED指示灯]
    
    V --> AA{当前通道}
    X --> AA
    Y --> AA
    
    AA -->|温湿度通道| BB[DHT11数据采集]
    AA -->|频率通道| CC[NE555频率测量]
    
    BB --> DD[数据校验和计算]
    CC --> DD
    DD --> EE[串口发送数据]
    EE --> FF[LCD显示数据]
    
    FF --> GG{上位机接收?}
    GG -->|是| HH[数据验证]
    GG -->|否| H
    
    HH --> II{数据有效?}
    II -->|是| JJ[更新UI显示]
    II -->|否| KK[记录错误日志]
    
    JJ --> LL[阈值判断]
    LL --> MM{超出阈值?}
    MM -->|是| NN[发送报警信号]
    MM -->|否| OO[发送减半数据]
    
    NN --> PP[LED报警指示]
    OO --> QQ[PCF8591 DAC输出]
    
    JJ --> RR[网络数据发送]
    RR --> SS[Web服务器接收]
    SS --> TT[数据库存储]
    TT --> UU[Web界面更新]
    
    KK --> H
    PP --> H
    QQ --> H
    UU --> H
```

## 硬件初始化流程图

```mermaid
graph TD
    A[AT89C51上电] --> B[系统复位]
    B --> C[初始化变量]
    C --> D[UART_Init]
    D --> E[LCD_Init]
    E --> F[Timer0_Init]
    F --> G[INT0_Init]
    G --> H[EA = 1 总中断使能]
    H --> I[LCD显示"WAIT CMD"]
    I --> J[进入主循环]
    
    subgraph "UART初始化"
        D1[SCON = 0x50] --> D2[TMOD |= 0x20]
        D2 --> D3[TH1 = 0xFD]
        D3 --> D4[TL1 = 0xFD]
        D4 --> D5[TR1 = 1]
        D5 --> D6[ES = 1]
    end
    
    subgraph "LCD初始化"
        E1[LCD_WriteCmd 0x38] --> E2[LCD_WriteCmd 0x0C]
        E2 --> E3[LCD_WriteCmd 0x06]
        E3 --> E4[LCD_WriteCmd 0x01]
    end
    
    subgraph "定时器初始化"
        F1[TMOD &= 0xF0] --> F2[TMOD |= 0x01]
        F2 --> F3[TH0 = 65536-50000/256]
        F3 --> F4[TL0 = 65536-50000%256]
        F4 --> F5[ET0 = 1]
        F5 --> F6[TR0 = 1]
    end
    
    subgraph "外部中断初始化"
        G1[IT0 = 1] --> G2[下降沿触发]
    end
```

## 数据采集流程图

```mermaid
graph TD
    A[主循环开始] --> B{采集标志?}
    B -->|否| C[显示"WAIT CMD"]
    B -->|是| D{当前通道}
    
    D -->|温湿度| E[DHT11采集流程]
    D -->|频率| F[NE555频率测量]
    
    subgraph "DHT11采集流程"
        E1[DHT11_Start] --> E2[发送起始信号]
        E2 --> E3[Read_Data_From_DHT]
        E3 --> E4[读取5字节数据]
        E4 --> E5{校验和正确?}
        E5 -->|是| E6[提取温湿度值]
        E5 -->|否| E7[返回错误]
        E6 --> E8[LCD显示数据]
        E8 --> E9[串口发送数据]
    end
    
    subgraph "NE555频率测量"
        F1[使能外部中断EX0=1] --> F2[Timer0定时1秒]
        F2 --> F3[INT0_ISR计数脉冲]
        F3 --> F4[1秒后读取计数值]
        F4 --> F5[计数值即为频率]
        F5 --> F6[LCD显示频率]
        F6 --> F7[串口发送数据]
    end
    
    E --> G[数据校验和计算]
    F --> G
    G --> H[串口发送]
    H --> I[LCD显示]
    I --> J[等待下次采集]
    J --> A
```

## 上位机处理流程图

```mermaid
graph TD
    A[启动PyQt5应用] --> B[初始化MainWindow]
    B --> C[创建UI组件]
    C --> D[设置串口配置]
    D --> E[用户点击"打开串口"]
    E --> F[创建SerialThread]
    F --> G[启动串口监听]
    G --> H[用户点击"启动采集"]
    H --> I[发送CMD:S命令]
    I --> J[启动NetworkThread]
    J --> K[开始数据接收循环]
    
    K --> L{接收到数据?}
    L -->|是| M[数据验证]
    L -->|否| K
    
    M --> N{数据格式正确?}
    N -->|是| O[解析数据]
    N -->|否| P[记录错误日志]
    
    O --> Q{当前通道}
    Q -->|温湿度| R[解析T和H值]
    Q -->|频率| S[解析FREQ值]
    
    R --> T[更新温湿度显示]
    S --> U[更新频率显示]
    
    T --> V[阈值判断]
    U --> V
    
    V --> W{超出阈值?}
    W -->|是| X[发送报警信号]
    W -->|否| Y[发送减半数据]
    
    X --> Z[LED报警指示]
    Y --> AA[PCF8591 DAC输出]
    
    T --> BB[更新折线图]
    U --> BB
    BB --> CC[网络数据发送]
    CC --> DD[Web服务器]
    
    P --> K
    Z --> K
    AA --> K
    DD --> K
```

## 通信协议流程图

```mermaid
graph LR
    subgraph "下位机发送"
        A1[采集数据] --> A2[计算校验和]
        A2 --> A3[格式化数据]
        A3 --> A4[串口发送]
    end
    
    subgraph "上位机接收"
        B1[串口接收] --> B2[数据解析]
        B2 --> B3[校验和验证]
        B3 --> B4[数据有效性检查]
        B4 --> B5[阈值判断]
        B5 --> B6[发送响应]
    end
    
    subgraph "命令格式"
        C1[启动: CMD:S] --> C2[停止: CMD:E]
        C2 --> C3[温湿度: CMD:A]
        C3 --> C4[频率: CMD:B]
        C4 --> C5[报警: CMD:X/Y/Z]
        C5 --> C6[正常: CMD:x/y/z]
    end
    
    subgraph "数据格式"
        D1[温湿度: T:xx H:xx CHECKSUM:xxx]
        D2[频率: FREQ:xxxx CHECKSUM:xxx]
        D3[减半数据: xx xx CHECKSUM:xxx]
    end
    
    A4 --> B1
    B6 --> A1
```

## 报警处理流程图

```mermaid
graph TD
    A[数据接收] --> B[阈值判断]
    B --> C{温度超出范围?}
    C -->|是| D[发送CMD:X]
    C -->|否| E[发送CMD:x]
    
    B --> F{湿度超出范围?}
    F -->|是| G[发送CMD:Y]
    F -->|否| H[发送CMD:y]
    
    B --> I{频率超出范围?}
    I -->|是| J[发送CMD:Z]
    I -->|否| K[发送CMD:z]
    
    D --> L[LED1点亮]
    E --> M[LED1熄灭]
    G --> N[LED2点亮]
    H --> O[LED2熄灭]
    J --> P[LED3点亮]
    K --> Q[LED3熄灭]
    
    L --> R[下位机接收报警命令]
    M --> R
    N --> R
    O --> R
    P --> R
    Q --> R
    
    R --> S[执行LED控制]
    S --> T[串口返回状态]
    T --> U[上位机显示报警状态]
```

## 网络传输流程图

```mermaid
graph TD
    A[上位机数据接收] --> B{网络发送启用?}
    B -->|是| C[准备JSON数据]
    B -->|否| D[跳过网络发送]
    
    C --> E{数据类型}
    E -->|温湿度| F[构建温湿度JSON]
    E -->|频率| G[构建频率JSON]
    
    F --> H[NetworkThread发送]
    G --> H
    
    H --> I[HTTP POST请求]
    I --> J{服务器响应}
    J -->|200| K[发送成功]
    J -->|其他| L[发送失败]
    
    K --> M[记录成功日志]
    L --> N[记录错误日志]
    
    M --> O[继续下次发送]
    N --> O
    D --> O
    O --> P[等待新数据]
    P --> A
```

## 用户操作流程图

```mermaid
graph TD
    A[用户启动系统] --> B[选择串口]
    B --> C[点击"打开串口"]
    C --> D{串口打开成功?}
    D -->|是| E[选择采集通道]
    D -->|否| F[显示错误信息]
    
    E --> G[设置阈值范围]
    G --> H[点击"启动采集"]
    H --> I[发送启动命令]
    I --> J{下位机响应?}
    J -->|是| K[开始数据采集]
    J -->|否| L[检查连接状态]
    
    K --> M[实时数据显示]
    M --> N[折线图更新]
    N --> O[阈值监控]
    O --> P{数据超出阈值?}
    P -->|是| Q[报警指示]
    P -->|否| R[正常显示]
    
    Q --> S[LED指示灯]
    R --> T[减半数据输出]
    
    S --> U[用户观察状态]
    T --> U
    U --> V{继续监控?}
    V -->|是| M
    V -->|否| W[点击"停止采集"]
    
    W --> X[发送停止命令]
    X --> Y[停止数据采集]
    Y --> Z[关闭串口]
    Z --> AA[系统结束]
    
    F --> BB[重新配置]
    L --> BB
    BB --> B
```

## 系统状态转换图

```mermaid
stateDiagram-v2
    [*] --> 初始化
    初始化 --> 等待命令: 硬件初始化完成
    等待命令 --> 串口连接: 上位机连接
    串口连接 --> 通道选择: 连接成功
    通道选择 --> 温湿度模式: 选择DHT11
    通道选择 --> 频率模式: 选择NE555
    温湿度模式 --> 数据采集: 发送启动命令
    频率模式 --> 数据采集: 发送启动命令
    数据采集 --> 数据处理: 接收数据
    数据处理 --> 阈值判断: 数据有效
    阈值判断 --> 正常状态: 数据在范围内
    阈值判断 --> 报警状态: 数据超出范围
    正常状态 --> 数据采集: 继续监控
    报警状态 --> 数据采集: 继续监控
    数据处理 --> 数据采集: 数据无效
    数据采集 --> 停止状态: 发送停止命令
    停止状态 --> 等待命令: 停止完成
    串口连接 --> 等待命令: 连接失败
```

## 数据流向图

```mermaid
graph LR
    subgraph "传感器层"
        A[DHT11温湿度传感器]
        B[NE555频率源]
    end
    
    subgraph "MCU层"
        C[AT89C51单片机]
        D[LCD1602显示]
        E[PCF8591 DAC]
        F[LED指示灯]
    end
    
    subgraph "通信层"
        G[串口通信]
        H[RS232接口]
    end
    
    subgraph "上位机层"
        I[PyQt5应用]
        J[数据验证]
        K[阈值判断]
        L[折线图显示]
    end
    
    subgraph "网络层"
        M[HTTP POST]
        N[Web服务器]
        O[SQLite数据库]
        P[Web监控界面]
    end
    
    A --> C
    B --> C
    C --> D
    C --> E
    C --> F
    C --> G
    G --> H
    H --> I
    I --> J
    J --> K
    K --> L
    I --> M
    M --> N
    N --> O
    O --> P
```

这个流程图完整地展示了整个温湿度/频率监控系统的工作流程，包括：

1. **系统初始化流程** - 硬件和软件的启动过程
2. **数据采集流程** - DHT11和NE555的数据获取过程
3. **上位机处理流程** - PyQt5应用的数据处理逻辑
4. **通信协议流程** - 上下位机之间的数据交换格式
5. **报警处理流程** - 阈值判断和报警机制
6. **网络传输流程** - 数据上传到Web服务器的过程
7. **用户操作流程** - 用户与系统的交互过程
8. **系统状态转换** - 各个工作状态之间的转换关系
9. **数据流向图** - 数据在系统中的流动路径

每个流程图都详细展示了系统的不同方面，帮助理解整个系统的工作原理和数据流向。 